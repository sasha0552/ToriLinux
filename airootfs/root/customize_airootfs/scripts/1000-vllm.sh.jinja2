#!/bin/sh
set -eu

{% if platform == "cuda" %}
# install vllm
pipx install "{{ gh_release("vllm") }}"

# remove triton
pipx runpip vllm uninstall -y triton

# install triton with pascal patches
pipx inject vllm "{{ gh_release("triton") }}"

# install nvidia-pstate
pipx inject vllm nvidia-pstate

# apply patches
pushd "$HOME/.local/share/pipx/venvs/vllm/lib/python3.11/site-packages"
  # drop pstate in idle
  patch -p1 < "$TORI_PATCHES/0000-vllm-drop-pstate-in-idle.patch"
popd
{% endif %}
