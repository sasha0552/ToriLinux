#!/bin/bash
set -eu

# clone repository
git clone "https://github.com/vladmandic/automatic.git"

# automatic patches
pushd "automatic"
  # use specific revision
  git checkout e783b098fd0ad28acabb29844ab0af0978684c04

  # clone submodules
  git submodule update --init --recursive

  # remove git dependency
  sed -i '/installer.check_modified_files()/d' launch.py
  sed -i '/installer.install_submodules()/d' launch.py
  sed -i '/installer.update_wiki()/d' launch.py
  sed -i 's/installer.check_timestamp()/False/g' launch.py

  # remove internet dependency
  sed -i '/installer.check_version()/d' launch.py
  sed -i 's/lambda: {"choices": theme.list_themes()}, refresh=theme.refresh_themes/{"choices": ["black-teal"]}/g' modules/shared.py
  sed -i 's/shared.opts.motd/False/g' modules/api/api.py

{% if platform == "cuda" %}
  # drop pstate in idle
  patch -p1 < "$CUSTOMIZE_AIROOTFS/patches/0000-automatic-drop-pstate-in-idle.patch"
{% endif %}
popd

# automatic dependencies
pushd "automatic"
  # disable package caching
  export PIP_NO_CACHE_DIR=0

  # create venv
  python3 -m venv venv

  # activate venv
  source venv/bin/activate
    {% if platform == "cuda" %}
    # install nvidia-pstate if cuda
    pip3 install nvidia-pstate
    {% endif %}

    # install dependencies
    python3 launch.py --test
  deactivate

  # remove installation config
  rm config.json

  # remove installation log
  rm sdnext.log
popd
